{% extends "base.html" %}

{% block title %}AI Boxing Trainer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="module-card p-3">
            <h3 class="text-center mb-3"><i class="fas fa-video"></i> AI Boxing Trainer</h3>

            <!-- CLIENT CAMERA FEED -->
            <video id="clientCam" autoplay playsinline width="100%" style="border-radius: 10px;"></video>

            <canvas id="sendCanvas" style="display:none;"></canvas>

            <div class="text-center mt-3">
                <button class="btn btn-success me-2" onclick="startTraining()">
                    <i class="fas fa-play"></i> Start Session
                </button>
                <button class="btn btn-warning me-2" onclick="resetStats()">
                    <i class="fas fa-redo"></i> Reset Stats
                </button>
                <button class="btn btn-danger" onclick="endSession()">
                    <i class="fas fa-stop"></i> End Session
                </button>
            </div>
        </div>
    </div>

    <!-- === STATISTICS SECTION UNCHANGED === -->
    <div class="col-lg-4">
        <div class="module-card p-3">
            <h4 class="text-center">Training Statistics</h4>

            <div id="statsDisplay">
                <div class="stats-card">
                    <div class="row text-center">
                        <div class="col-6">
                            <h6>Total Punches</h6>
                            <h3 id="totalPunches">0</h3>
                        </div>
                        <div class="col-6">
                            <h6>Accuracy</h6>
                            <h3 id="accuracy">0%</h3>
                        </div>
                    </div>

                    <div class="row text-center mt-3">
                        <div class="col-6">
                            <h6>Session Time</h6>
                            <h4 id="sessionTime">0s</h4>
                        </div>
                        <div class="col-6">
                            <h6>Punches/Min</h6>
                            <h4 id="punchesPerMin">0</h4>
                        </div>
                    </div>

                    <div class="mt-3">
                        <h6>Guard Perfection</h6>
                        <div class="progress mb-2">
                            <div id="guardProgress" class="progress-bar bg-success" style="width: 0%">0%</div>
                        </div>
                    </div>
                </div>

                <h5 class="mt-4">Punch Breakdown</h5>
                <div class="row text-center">
                    <div class="col-3"><small>Jabs</small><h5 id="jabCount">0</h5></div>
                    <div class="col-3"><small>Crosses</small><h5 id="crossCount">0</h5></div>
                    <div class="col-3"><small>Hooks</small><h5 id="hookCount">0</h5></div>
                    <div class="col-3"><small>Uppercuts</small><h5 id="upperCount">0</h5></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let sending = false;
let statsInterval;

// === ENABLE CLIENT WEBCAM ===
async function startClientCamera() {
    const video = document.getElementById("clientCam");
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
}
startClientCamera();

// === SEND FRAMES TO FLASK ===
function sendFramesToServer() {
    if (!sending) return;

    const video = document.getElementById("clientCam");
    const canvas = document.getElementById("sendCanvas");
    const ctx = canvas.getContext("2d");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const frame = canvas.toDataURL("image/jpeg");

    fetch("/pose-trainer/process-frame", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ frame: frame })
    });

    requestAnimationFrame(sendFramesToServer);
}

// === UPDATE STATS ===
function updateStats() {
    fetch('/pose-trainer/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalPunches').textContent = data.total_punches;
            document.getElementById('accuracy').textContent = data.accuracy + '%';
            document.getElementById('sessionTime').textContent = Math.round(data.session_duration) + 's';
            document.getElementById('punchesPerMin').textContent = data.punches_per_minute;

            document.getElementById('guardProgress').style.width = data.guard_perfection + '%';
            document.getElementById('guardProgress').textContent = data.guard_perfection + '%';

            document.getElementById('jabCount').textContent = data.punch_counts.Jab || 0;
            document.getElementById('crossCount').textContent = data.punch_counts.Cross || 0;
            document.getElementById('hookCount').textContent = data.punch_counts.Hook || 0;
            document.getElementById('upperCount').textContent = data.punch_counts.Uppercut || 0;
        });
}

function startTraining() {
    sending = true;
    sendFramesToServer();

    if (!statsInterval) {
        statsInterval = setInterval(updateStats, 1000);
    }

    alert("Training started â€” client camera active!");
}

function resetStats() {
    fetch('/pose-trainer/reset_stats')
        .then(res => res.json())
        .then(() => alert("Stats reset!"));
}

function endSession() {
    sending = false;
    clearInterval(statsInterval);
    statsInterval = null;

    window.location.href = "/pose-trainer/end_session";
}

document.addEventListener("DOMContentLoaded", () => {
    updateStats();
});
</script>
{% endblock %}
